<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rate Limiting Test - Session 78</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #22c55e; font-weight: bold; }
        .error { color: #ef4444; font-weight: bold; }
        .warning { color: #f59e0b; font-weight: bold; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 4px;
            border-left: 4px solid #3b82f6;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        h1 { color: #1f2937; }
        h2 { color: #374151; font-size: 18px; margin-bottom: 10px; }
        .progress {
            margin-top: 10px;
            font-size: 14px;
            color: #6b7280;
        }
        .header-info {
            background: #eff6ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #3b82f6;
        }
        .summary {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #22c55e;
            margin: 20px 0;
        }
        code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üõ°Ô∏è Rate Limiting Test Suite - Session 78</h1>
    <p>Testing API rate limiting feature with all 6 test steps from feature_list.json</p>

    <div class="test-section">
        <h2>Step 1: Make Rapid API Calls</h2>
        <p>Make multiple rapid API calls to test rate limiting</p>
        <button onclick="testStep1()">Run Step 1</button>
        <button onclick="runAllTests()">Run All Tests</button>
        <div id="step1-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>Step 2: Verify Rate Limit Applied</h2>
        <p>Check that rate limit is being tracked</p>
        <button onclick="testStep2()">Run Step 2</button>
        <div id="step2-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>Step 3: Verify 429 Status Returned</h2>
        <p>Exceed rate limit and verify 429 status code</p>
        <button onclick="testStep3()">Run Step 3</button>
        <div id="step3-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>Step 4: Verify Rate Limit Headers Present</h2>
        <p>Check that rate limit headers are included in responses</p>
        <button onclick="testStep4()">Run Step 4</button>
        <div id="step4-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>Step 5: Wait and Retry</h2>
        <p>Wait for rate limit window to reset and retry</p>
        <button id="step5-btn" onclick="testStep5()">Run Step 5</button>
        <div id="step5-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>Step 6: Verify Access Restored</h2>
        <p>Verify that after waiting, access is restored</p>
        <button onclick="testStep6()">Run Step 6</button>
        <div id="step6-result" class="result" style="display:none;"></div>
    </div>

    <div id="summary" class="summary" style="display:none;">
        <h2>üéØ Test Summary</h2>
        <div id="summary-content"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:8001';
        let testResults = {
            step1: false,
            step2: false,
            step3: false,
            step4: false,
            step5: false,
            step6: false
        };

        async function testStep1() {
            const resultDiv = document.getElementById('step1-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="warning">‚è≥ Testing...</span>\n';

            try {
                // Make 10 rapid API calls
                const promises = [];
                for (let i = 0; i < 10; i++) {
                    promises.push(fetch(`${API_URL}/api/health`));
                }

                const responses = await Promise.all(promises);
                const statuses = responses.map(r => r.status);
                const allSuccess = statuses.every(s => s === 200);

                if (allSuccess) {
                    resultDiv.innerHTML = `<span class="success">‚úÖ PASS - Step 1</span>\n`;
                    resultDiv.innerHTML += `Made 10 rapid API calls\n`;
                    resultDiv.innerHTML += `All responses: 200 OK\n`;
                    resultDiv.innerHTML += `Rate limiting middleware is active and tracking requests\n`;
                    testResults.step1 = true;
                } else {
                    resultDiv.innerHTML = `<span class="error">‚ùå FAIL</span>\n`;
                    resultDiv.innerHTML += `Unexpected status codes: ${statuses.join(', ')}\n`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå FAIL</span>\nError: ${error.message}`;
            }
        }

        async function testStep2() {
            const resultDiv = document.getElementById('step2-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="warning">‚è≥ Testing...</span>\n';

            try {
                // Make a request and check rate limit headers
                const response = await fetch(`${API_URL}/api/health`);
                const limit = response.headers.get('X-RateLimit-Limit');
                const remaining = response.headers.get('X-RateLimit-Remaining');
                const reset = response.headers.get('X-RateLimit-Reset');

                if (limit && remaining !== null && reset) {
                    resultDiv.innerHTML = `<span class="success">‚úÖ PASS - Step 2</span>\n`;
                    resultDiv.innerHTML += `Rate limit is being tracked\n\n`;
                    resultDiv.innerHTML += `Rate Limit Headers:\n`;
                    resultDiv.innerHTML += `  X-RateLimit-Limit: ${limit}\n`;
                    resultDiv.innerHTML += `  X-RateLimit-Remaining: ${remaining}\n`;
                    resultDiv.innerHTML += `  X-RateLimit-Reset: ${reset}\n`;
                    testResults.step2 = true;
                } else {
                    resultDiv.innerHTML = `<span class="error">‚ùå FAIL</span>\n`;
                    resultDiv.innerHTML += `Missing rate limit headers\n`;
                    resultDiv.innerHTML += `Limit: ${limit}, Remaining: ${remaining}, Reset: ${reset}\n`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå FAIL</span>\nError: ${error.message}`;
            }
        }

        async function testStep3() {
            const resultDiv = document.getElementById('step3-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="warning">‚è≥ Testing... (making 101 requests to exceed limit)</span>\n';

            try {
                // Make 101 requests to exceed the limit of 100
                const responses = [];
                for (let i = 0; i < 101; i++) {
                    const response = await fetch(`${API_URL}/api/health`);
                    responses.push(response);

                    // Show progress
                    if (i % 20 === 0) {
                        resultDiv.innerHTML = `<span class="warning">‚è≥ Testing...</span>\nProgress: ${i + 1}/101 requests\n`;
                    }
                }

                // Check if we got a 429 status
                const has429 = responses.some(r => r.status === 429);
                const last429 = responses.reverse().find(r => r.status === 429);

                if (has429 && last429) {
                    const errorData = await last429.json();
                    resultDiv.innerHTML = `<span class="success">‚úÖ PASS - Step 3</span>\n`;
                    resultDiv.innerHTML += `Made 101 requests\n`;
                    resultDiv.innerHTML += `Rate limit exceeded - received 429 status\n\n`;
                    resultDiv.innerHTML += `429 Response:\n`;
                    resultDiv.innerHTML += JSON.stringify(errorData, null, 2);
                    testResults.step3 = true;
                } else {
                    resultDiv.innerHTML = `<span class="error">‚ùå FAIL</span>\n`;
                    resultDiv.innerHTML += `Expected 429 status but didn't receive it\n`;
                    resultDiv.innerHTML += `Response statuses: ${responses.map(r => r.status).join(', ')}\n`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå FAIL</span>\nError: ${error.message}`;
            }
        }

        async function testStep4() {
            const resultDiv = document.getElementById('step4-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="warning">‚è≥ Testing...</span>\n';

            try {
                // Make enough requests to trigger rate limit
                for (let i = 0; i < 100; i++) {
                    await fetch(`${API_URL}/api/health`);
                }

                // Make one more to get 429
                const response = await fetch(`${API_URL}/api/health`);

                if (response.status === 429) {
                    const limit = response.headers.get('X-RateLimit-Limit');
                    const remaining = response.headers.get('X-RateLimit-Remaining');
                    const reset = response.headers.get('X-RateLimit-Reset');
                    const retryAfter = response.headers.get('Retry-After');

                    const hasAllHeaders = limit && remaining !== null && reset && retryAfter;

                    if (hasAllHeaders) {
                        resultDiv.innerHTML = `<span class="success">‚úÖ PASS - Step 4</span>\n`;
                        resultDiv.innerHTML += `All rate limit headers present in 429 response:\n\n`;
                        resultDiv.innerHTML += `  X-RateLimit-Limit: ${limit}\n`;
                        resultDiv.innerHTML += `  X-RateLimit-Remaining: ${remaining}\n`;
                        resultDiv.innerHTML += `  X-RateLimit-Reset: ${reset}\n`;
                        resultDiv.innerHTML += `  Retry-After: ${retryAfter} seconds\n`;
                        testResults.step4 = true;
                    } else {
                        resultDiv.innerHTML = `<span class="error">‚ùå FAIL</span>\n`;
                        resultDiv.innerHTML += `Missing headers in 429 response\n`;
                        resultDiv.innerHTML += `Limit: ${limit}, Remaining: ${remaining}, Reset: ${reset}, Retry-After: ${retryAfter}\n`;
                    }
                } else {
                    resultDiv.innerHTML = `<span class="error">‚ùå FAIL</span>\n`;
                    resultDiv.innerHTML += `Expected 429 status but got ${response.status}\n`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå FAIL</span>\nError: ${error.message}`;
            }
        }

        async function testStep5() {
            const resultDiv = document.getElementById('step5-result');
            const btn = document.getElementById('step5-btn');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="warning">‚è≥ Testing...</span>\n';

            try {
                // First, trigger rate limit
                for (let i = 0; i < 100; i++) {
                    await fetch(`${API_URL}/api/health`);
                }

                const response429 = await fetch(`${API_URL}/api/health`);

                if (response429.status === 429) {
                    const retryAfter = parseInt(response429.headers.get('Retry-After') || '60');
                    resultDiv.innerHTML = `<span class="warning">‚è≥ Rate limit hit!</span>\n`;
                    resultDiv.innerHTML += `Waiting ${retryAfter} seconds for window to reset...\n`;

                    btn.disabled = true;

                    // Wait for the retry-after period
                    let countdown = retryAfter;
                    const interval = setInterval(() => {
                        countdown--;
                        resultDiv.innerHTML = `<span class="warning">‚è≥ Waiting...</span>\n`;
                        resultDiv.innerHTML += `Time remaining: ${countdown} seconds\n`;
                    }, 1000);

                    await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
                    clearInterval(interval);

                    // Try again after waiting
                    const retryResponse = await fetch(`${API_URL}/api/health`);

                    if (retryResponse.status === 200) {
                        resultDiv.innerHTML = `<span class="success">‚úÖ PASS - Step 5</span>\n`;
                        resultDiv.innerHTML += `Waited ${retryAfter} seconds\n`;
                        resultDiv.innerHTML += `Retry successful - status: ${retryResponse.status}\n`;
                        testResults.step5 = true;
                    } else {
                        resultDiv.innerHTML = `<span class="error">‚ùå FAIL</span>\n`;
                        resultDiv.innerHTML += `After waiting, still got status ${retryResponse.status}\n`;
                    }

                    btn.disabled = false;
                } else {
                    resultDiv.innerHTML = `<span class="error">‚ùå FAIL</span>\n`;
                    resultDiv.innerHTML += `Could not trigger rate limit initially\n`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå FAIL</span>\nError: ${error.message}`;
                btn.disabled = false;
            }
        }

        async function testStep6() {
            const resultDiv = document.getElementById('step6-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="warning">‚è≥ Testing...</span>\n';

            try {
                // Make a few successful requests to verify access is restored
                const promises = [];
                for (let i = 0; i < 5; i++) {
                    promises.push(fetch(`${API_URL}/api/health`));
                }

                const responses = await Promise.all(promises);
                const allSuccess = responses.every(r => r.status === 200);
                const firstResponse = responses[0];
                const remaining = firstResponse.headers.get('X-RateLimit-Remaining');

                if (allSuccess && remaining) {
                    resultDiv.innerHTML = `<span class="success">‚úÖ PASS - Step 6</span>\n`;
                    resultDiv.innerHTML += `Access fully restored!\n`;
                    resultDiv.innerHTML += `Made 5 successful requests\n`;
                    resultDiv.innerHTML += `All responses: 200 OK\n`;
                    resultDiv.innerHTML += `Remaining requests: ${remaining}\n`;
                    testResults.step6 = true;

                    showSummary();
                } else {
                    resultDiv.innerHTML = `<span class="error">‚ùå FAIL</span>\n`;
                    resultDiv.innerHTML += `Access not fully restored\n`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå FAIL</span>\nError: ${error.message}`;
            }
        }

        function showSummary() {
            const summaryDiv = document.getElementById('summary');
            const summaryContent = document.getElementById('summary-content');
            summaryDiv.style.display = 'block';

            const totalTests = 6;
            const passedTests = Object.values(testResults).filter(r => r === true).length;
            const allPassed = passedTests === totalTests;

            summaryContent.innerHTML = `
                <strong>Total Tests:</strong> ${totalTests}<br>
                <strong>Passed:</strong> ${passedTests}<br>
                <strong>Failed:</strong> ${totalTests - passedTests}<br>
                <strong>Success Rate:</strong> ${((passedTests / totalTests) * 100).toFixed(1)}%<br>
                <br>
                ${allPassed ?
                    '<span class="success">üéâ All tests passed! Rate limiting feature is working correctly!</span>' :
                    '<span class="error">‚ö†Ô∏è Some tests failed. Please review the results above.</span>'
                }
            `;
        }

        async function runAllTests() {
            alert('This will run all 6 tests sequentially. Step 5 includes a 60-second wait. Total time: ~2-3 minutes. Click OK to proceed.');

            await testStep1();
            await new Promise(r => setTimeout(r, 1000));

            await testStep2();
            await new Promise(r => setTimeout(r, 1000));

            await testStep3();
            await new Promise(r => setTimeout(r, 2000));

            await testStep4();
            await new Promise(r => setTimeout(r, 2000));

            await testStep5();
            await new Promise(r => setTimeout(r, 2000));

            await testStep6();
        }
    </script>
</body>
</html>
