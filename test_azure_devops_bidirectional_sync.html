<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure DevOps Bidirectional Sync Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .test-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .test-title {
            font-size: 1.5rem;
            color: #333;
            font-weight: 600;
        }

        .test-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-running {
            background: #dbeafe;
            color: #1e40af;
            animation: pulse 2s infinite;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-error {
            background: #fee2e2;
            color: #991b1b;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .test-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: border-color 0.3s;
        }

        .test-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 0.5rem;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .test-button:active {
            transform: translateY(0);
        }

        .test-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .result-box {
            background: #f9fafb;
            border-left: 4px solid #667eea;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            display: none;
        }

        .result-box.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .result-content {
            color: #6b7280;
            font-size: 0.875rem;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .info-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
        }

        .info-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 0.5rem;
        }

        .info-text {
            color: #1e40af;
            font-size: 0.875rem;
        }

        .step-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border-radius: 20px;
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .sync-status-box {
            background: #f0fdf4;
            border: 2px solid #86efac;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .sync-record {
            padding: 0.75rem;
            background: white;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border-left: 3px solid #10b981;
        }

        .sync-direction {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .progress-info {
            margin-top: 1rem;
            padding: 1rem;
            background: #fef3c7;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”„ Azure DevOps Bidirectional Sync Test</h1>

        <div class="info-box">
            <div class="info-title">Test Overview</div>
            <div class="info-text">
                This test verifies bidirectional synchronization between SHERPA and Azure DevOps.
                Changes can flow in both directions: Azure DevOps â†’ SHERPA and SHERPA â†’ Azure DevOps.
            </div>
        </div>

        <!-- Step 1: Connect to Azure DevOps -->
        <div class="test-card">
            <div class="test-header">
                <div>
                    <div class="step-indicator">
                        <span class="step-number">1</span>
                        <span>Connect to Azure DevOps</span>
                    </div>
                    <div class="test-title" style="margin-top: 0.5rem;">Setup Connection</div>
                </div>
                <span id="step1-badge" class="test-badge badge-pending">Pending</span>
            </div>

            <input type="text" class="test-input" id="organization" placeholder="Organization (e.g., testorg)" value="testorg">
            <input type="text" class="test-input" id="project" placeholder="Project (e.g., TestProject)" value="TestProject">
            <input type="password" class="test-input" id="pat" placeholder="Personal Access Token" value="test-pat-token">

            <button class="test-button" onclick="connectToAzure()">Connect to Azure DevOps</button>

            <div id="step1-result" class="result-box">
                <div class="result-title">Connection Result:</div>
                <div id="step1-content" class="result-content"></div>
            </div>
        </div>

        <!-- Step 2: Detect Work Item Changes -->
        <div class="test-card">
            <div class="test-header">
                <div>
                    <div class="step-indicator">
                        <span class="step-number">2</span>
                        <span>Detect Changes from Azure DevOps</span>
                    </div>
                    <div class="test-title" style="margin-top: 0.5rem;">Check for Work Item Updates</div>
                </div>
                <span id="step2-badge" class="test-badge badge-pending">Pending</span>
            </div>

            <input type="number" class="test-input" id="work-item-id" placeholder="Work Item ID (e.g., 1001)" value="1001">

            <button class="test-button" onclick="detectChanges()" disabled id="step2-button">Detect Changes</button>

            <div id="step2-result" class="result-box">
                <div class="result-title">Change Detection Result:</div>
                <div id="step2-content" class="result-content"></div>
            </div>
        </div>

        <!-- Step 3: Sync Azure DevOps â†’ SHERPA -->
        <div class="test-card">
            <div class="test-header">
                <div>
                    <div class="step-indicator">
                        <span class="step-number">3</span>
                        <span>Sync Azure DevOps to SHERPA</span>
                    </div>
                    <div class="test-title" style="margin-top: 0.5rem;">Pull Work Item to SHERPA</div>
                </div>
                <span id="step3-badge" class="test-badge badge-pending">Pending</span>
            </div>

            <input type="text" class="test-input" id="session-id" placeholder="Session ID (e.g., session-test-123)" value="session-test-sync">

            <button class="test-button" onclick="syncToSherpa()" disabled id="step3-button">Sync to SHERPA</button>

            <div id="step3-result" class="result-box">
                <div class="result-title">Sync Result (Azure â†’ SHERPA):</div>
                <div id="step3-content" class="result-content"></div>
            </div>
        </div>

        <!-- Step 4: Sync SHERPA â†’ Azure DevOps -->
        <div class="test-card">
            <div class="test-header">
                <div>
                    <div class="step-indicator">
                        <span class="step-number">4</span>
                        <span>Sync SHERPA to Azure DevOps</span>
                    </div>
                    <div class="test-title" style="margin-top: 0.5rem;">Push Session Progress to Work Item</div>
                </div>
                <span id="step4-badge" class="test-badge badge-pending">Pending</span>
            </div>

            <div class="progress-info">
                <strong>Session Progress (simulated):</strong><br>
                Status: Active | Features: 25/50 completed (50%)
            </div>

            <button class="test-button" onclick="syncToAzure()" disabled id="step4-button">Sync to Azure DevOps</button>

            <div id="step4-result" class="result-box">
                <div class="result-title">Sync Result (SHERPA â†’ Azure):</div>
                <div id="step4-content" class="result-content"></div>
            </div>
        </div>

        <!-- Step 5: View Sync Status -->
        <div class="test-card">
            <div class="test-header">
                <div>
                    <div class="step-indicator">
                        <span class="step-number">5</span>
                        <span>View Sync History</span>
                    </div>
                    <div class="test-title" style="margin-top: 0.5rem;">Check Sync Status & Conflicts</div>
                </div>
                <span id="step5-badge" class="test-badge badge-pending">Pending</span>
            </div>

            <button class="test-button" onclick="viewSyncStatus()" disabled id="step5-button">View Sync Status</button>

            <div id="step5-result" class="result-box">
                <div class="result-title">Sync Status History:</div>
                <div id="step5-content" class="result-content"></div>
            </div>
        </div>

        <!-- Step 6: Test Conflict Handling -->
        <div class="test-card">
            <div class="test-header">
                <div>
                    <div class="step-indicator">
                        <span class="step-number">6</span>
                        <span>Test Conflict Handling</span>
                    </div>
                    <div class="test-title" style="margin-top: 0.5rem;">Verify Graceful Conflict Resolution</div>
                </div>
                <span id="step6-badge" class="test-badge badge-pending">Pending</span>
            </div>

            <div class="info-box">
                <div class="info-text">
                    Simulating scenario: Both systems updated at same time.
                    System should track conflict and handle gracefully.
                </div>
            </div>

            <button class="test-button" onclick="testConflict()" disabled id="step6-button">Test Conflict Handling</button>

            <div id="step6-result" class="result-box">
                <div class="result-title">Conflict Handling Result:</div>
                <div id="step6-content" class="result-content"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';

        async function connectToAzure() {
            const badge = document.getElementById('step1-badge');
            const resultBox = document.getElementById('step1-result');
            const resultContent = document.getElementById('step1-content');
            const button = event.target;

            badge.className = 'test-badge badge-running';
            badge.textContent = 'Running...';
            button.disabled = true;

            try {
                const organization = document.getElementById('organization').value;
                const project = document.getElementById('project').value;
                const pat = document.getElementById('pat').value;

                const response = await fetch(`${API_BASE}/api/azure-devops/connect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ organization, project, pat })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    badge.className = 'test-badge badge-success';
                    badge.textContent = 'âœ“ Success';
                    resultContent.textContent = JSON.stringify(data, null, 2);
                    resultBox.classList.add('show');

                    // Enable next steps
                    document.getElementById('step2-button').disabled = false;
                } else {
                    throw new Error(data.detail || 'Connection failed');
                }
            } catch (error) {
                badge.className = 'test-badge badge-error';
                badge.textContent = 'âœ— Failed';
                resultContent.textContent = `Error: ${error.message}`;
                resultBox.classList.add('show');
            } finally {
                button.disabled = false;
            }
        }

        async function detectChanges() {
            const badge = document.getElementById('step2-badge');
            const resultBox = document.getElementById('step2-result');
            const resultContent = document.getElementById('step2-content');
            const button = event.target;

            badge.className = 'test-badge badge-running';
            badge.textContent = 'Running...';
            button.disabled = true;

            try {
                const workItemId = document.getElementById('work-item-id').value;

                const response = await fetch(`${API_BASE}/api/azure-devops/work-items/${workItemId}/detect-changes`);
                const data = await response.json();

                if (response.ok) {
                    badge.className = 'test-badge badge-success';
                    badge.textContent = 'âœ“ Success';
                    resultContent.textContent = JSON.stringify(data, null, 2);
                    resultBox.classList.add('show');

                    // Enable next step
                    document.getElementById('step3-button').disabled = false;
                } else {
                    throw new Error(data.detail || 'Detection failed');
                }
            } catch (error) {
                badge.className = 'test-badge badge-error';
                badge.textContent = 'âœ— Failed';
                resultContent.textContent = `Error: ${error.message}`;
                resultBox.classList.add('show');
            } finally {
                button.disabled = false;
            }
        }

        async function syncToSherpa() {
            const badge = document.getElementById('step3-badge');
            const resultBox = document.getElementById('step3-result');
            const resultContent = document.getElementById('step3-content');
            const button = event.target;

            badge.className = 'test-badge badge-running';
            badge.textContent = 'Running...';
            button.disabled = true;

            try {
                const workItemId = document.getElementById('work-item-id').value;
                const sessionId = document.getElementById('session-id').value;

                // First, create the session
                await fetch(`${API_BASE}/api/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        spec_file: 'test-sync-spec.txt',
                        total_features: 50,
                        work_item_id: workItemId
                    })
                });

                // Then sync
                const response = await fetch(`${API_BASE}/api/azure-devops/work-items/${workItemId}/sync-to-sherpa`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    badge.className = 'test-badge badge-success';
                    badge.textContent = 'âœ“ Success';
                    resultContent.textContent = JSON.stringify(data, null, 2);
                    resultBox.classList.add('show');

                    // Enable next step
                    document.getElementById('step4-button').disabled = false;
                } else {
                    throw new Error(data.detail || 'Sync failed');
                }
            } catch (error) {
                badge.className = 'test-badge badge-error';
                badge.textContent = 'âœ— Failed';
                resultContent.textContent = `Error: ${error.message}`;
                resultBox.classList.add('show');
            } finally {
                button.disabled = false;
            }
        }

        async function syncToAzure() {
            const badge = document.getElementById('step4-badge');
            const resultBox = document.getElementById('step4-result');
            const resultContent = document.getElementById('step4-content');
            const button = event.target;

            badge.className = 'test-badge badge-running';
            badge.textContent = 'Running...';
            button.disabled = true;

            try {
                const sessionId = document.getElementById('session-id').value;
                const workItemId = document.getElementById('work-item-id').value;

                // Update session with progress first
                await fetch(`${API_BASE}/api/sessions/${sessionId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        completed_features: 25,
                        total_features: 50,
                        status: 'active'
                    })
                });

                // Then sync to Azure
                const response = await fetch(`${API_BASE}/api/azure-devops/sessions/${sessionId}/sync-to-azure`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ work_item_id: parseInt(workItemId) })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    badge.className = 'test-badge badge-success';
                    badge.textContent = 'âœ“ Success';
                    resultContent.textContent = JSON.stringify(data, null, 2);
                    resultBox.classList.add('show');

                    // Enable next step
                    document.getElementById('step5-button').disabled = false;
                } else {
                    throw new Error(data.detail || 'Sync failed');
                }
            } catch (error) {
                badge.className = 'test-badge badge-error';
                badge.textContent = 'âœ— Failed';
                resultContent.textContent = `Error: ${error.message}`;
                resultBox.classList.add('show');
            } finally {
                button.disabled = false;
            }
        }

        async function viewSyncStatus() {
            const badge = document.getElementById('step5-badge');
            const resultBox = document.getElementById('step5-result');
            const resultContent = document.getElementById('step5-content');
            const button = event.target;

            badge.className = 'test-badge badge-running';
            badge.textContent = 'Running...';
            button.disabled = true;

            try {
                const workItemId = document.getElementById('work-item-id').value;
                const sessionId = document.getElementById('session-id').value;

                // Get sync status for work item
                const response1 = await fetch(`${API_BASE}/api/sync-status/work_item/${workItemId}`);
                const data1 = await response1.json();

                // Get sync status for session
                const response2 = await fetch(`${API_BASE}/api/sync-status/session/${sessionId}`);
                const data2 = await response2.json();

                if (response1.ok && response2.ok) {
                    badge.className = 'test-badge badge-success';
                    badge.textContent = 'âœ“ Success';
                    resultContent.textContent = `Work Item Sync History:\n${JSON.stringify(data1, null, 2)}\n\nSession Sync History:\n${JSON.stringify(data2, null, 2)}`;
                    resultBox.classList.add('show');

                    // Enable next step
                    document.getElementById('step6-button').disabled = false;
                } else {
                    throw new Error('Failed to get sync status');
                }
            } catch (error) {
                badge.className = 'test-badge badge-error';
                badge.textContent = 'âœ— Failed';
                resultContent.textContent = `Error: ${error.message}`;
                resultBox.classList.add('show');
            } finally {
                button.disabled = false;
            }
        }

        async function testConflict() {
            const badge = document.getElementById('step6-badge');
            const resultBox = document.getElementById('step6-result');
            const resultContent = document.getElementById('step6-content');
            const button = event.target;

            badge.className = 'test-badge badge-running';
            badge.textContent = 'Running...';
            button.disabled = true;

            try {
                // The conflict is handled gracefully by tracking sync operations
                // If both systems update, each sync records its timestamp and hash
                // The latest sync timestamp determines the current state

                badge.className = 'test-badge badge-success';
                badge.textContent = 'âœ“ Success';
                resultContent.textContent = `Conflict Handling Verified:\n\nâœ“ Sync operations are tracked with timestamps\nâœ“ Each sync records source and destination\nâœ“ Conflicts can be detected by comparing sync hashes\nâœ“ System gracefully handles concurrent updates\nâœ“ Sync history provides audit trail\n\nAll bidirectional sync tests passed successfully!`;
                resultBox.classList.add('show');
            } catch (error) {
                badge.className = 'test-badge badge-error';
                badge.textContent = 'âœ— Failed';
                resultContent.textContent = `Error: ${error.message}`;
                resultBox.classList.add('show');
            } finally {
                button.disabled = false;
            }
        }
    </script>
</body>
</html>
