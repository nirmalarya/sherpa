<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: GET /api/sessions/:id/commits</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .test-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .summary-stats {
            display: flex;
            gap: 30px;
            margin-top: 15px;
        }

        .stat {
            flex: 1;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
        }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
        }

        .progress-fill {
            background: #48bb78;
            height: 100%;
            transition: width 0.3s ease;
        }

        .session-selector {
            margin-bottom: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .session-selector label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .session-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
            background: white;
        }

        .session-info {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .session-info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .session-info-item:last-child {
            border-bottom: none;
        }

        .test-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .test-step {
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #cbd5e0;
        }

        .test-step.running {
            border-left-color: #4299e1;
            background: #ebf8ff;
        }

        .test-step.passed {
            border-left-color: #48bb78;
            background: #f0fff4;
        }

        .test-step.failed {
            border-left-color: #f56565;
            background: #fff5f5;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .step-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 16px;
        }

        .step-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .step-status.pending {
            background: #e2e8f0;
            color: #4a5568;
        }

        .step-status.running {
            background: #bee3f8;
            color: #2c5282;
        }

        .step-status.passed {
            background: #c6f6d5;
            color: #22543d;
        }

        .step-status.failed {
            background: #fed7d7;
            color: #742a2a;
        }

        .step-content {
            color: #4a5568;
            line-height: 1.6;
        }

        .step-result {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .success {
            color: #22543d;
        }

        .error {
            color: #742a2a;
        }

        .commit-entry {
            margin: 8px 0;
            padding: 12px;
            background: #f7fafc;
            border-radius: 6px;
            border-left: 3px solid #4299e1;
        }

        .commit-hash {
            font-family: 'Courier New', monospace;
            color: #4299e1;
            font-weight: 600;
        }

        .commit-message {
            margin: 5px 0;
            color: #2d3748;
        }

        .commit-meta {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ§ª API Endpoint Test</h1>
        <p class="subtitle">GET /api/sessions/:id/commits - Get session git commits</p>

        <div class="test-summary">
            <div style="font-size: 18px; font-weight: 600;">Test Progress</div>
            <div class="summary-stats">
                <div class="stat">
                    <div class="stat-label">Total Tests</div>
                    <div class="stat-value" id="total-tests">6</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Passed</div>
                    <div class="stat-value" id="passed-tests">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Failed</div>
                    <div class="stat-value" id="failed-tests">0</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
        </div>

        <div class="session-selector">
            <label for="session-select">Select Test Session:</label>
            <select id="session-select">
                <option value="">Loading sessions...</option>
            </select>
            <div id="session-info" class="session-info" style="display: none;"></div>
        </div>

        <div class="test-steps">
            <div class="test-step" id="step-1">
                <div class="step-header">
                    <div class="step-title">Step 1: Load Available Sessions</div>
                    <div class="step-status pending">Pending</div>
                </div>
                <div class="step-content">Fetch all sessions from GET /api/sessions to populate selector</div>
                <div class="step-result" id="result-1" style="display: none;"></div>
            </div>

            <div class="test-step" id="step-2">
                <div class="step-header">
                    <div class="step-title">Step 2: Add Test Commit to Session</div>
                    <div class="step-status pending">Pending</div>
                </div>
                <div class="step-content">Add a test commit to the selected session (if needed)</div>
                <div class="step-result" id="result-2" style="display: none;"></div>
            </div>

            <div class="test-step" id="step-3">
                <div class="step-header">
                    <div class="step-title">Step 3: Get Session Commits</div>
                    <div class="step-status pending">Pending</div>
                </div>
                <div class="step-content">Send GET request to /api/sessions/:id/commits and verify 200 status</div>
                <div class="step-result" id="result-3" style="display: none;"></div>
            </div>

            <div class="test-step" id="step-4">
                <div class="step-header">
                    <div class="step-title">Step 4: Verify Commit Array Format</div>
                    <div class="step-status pending">Pending</div>
                </div>
                <div class="step-content">Verify response contains commits array with proper structure</div>
                <div class="step-result" id="result-4" style="display: none;"></div>
            </div>

            <div class="test-step" id="step-5">
                <div class="step-title">Step 5: Verify Commit Details</div>
                <div class="step-status pending">Pending</div>
                <div class="step-content">Verify each commit has hash, message, author, and timestamp</div>
                <div class="step-result" id="result-5" style="display: none;"></div>
            </div>

            <div class="test-step" id="step-6">
                <div class="step-header">
                    <div class="step-title">Step 6: Test 404 Error Handling</div>
                    <div class="step-status pending">Pending</div>
                </div>
                <div class="step-content">Verify proper 404 response for non-existent session</div>
                <div class="step-result" id="result-6" style="display: none;"></div>
            </div>
        </div>

        <button id="run-tests" onclick="runTests()">Run All Tests</button>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';
        let selectedSessionId = null;
        let testsPassed = 0;
        let testsFailed = 0;

        // Auto-load sessions on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadSessions();
        });

        async function loadSessions() {
            try {
                const response = await fetch(`${API_BASE}/api/sessions`);
                const data = await response.json();

                const select = document.getElementById('session-select');
                select.innerHTML = '<option value="">-- Select a session --</option>';

                data.sessions.forEach(session => {
                    const option = document.createElement('option');
                    option.value = session.id;
                    option.textContent = `${session.id} (${session.status})`;
                    select.appendChild(option);
                });

                // Auto-select first session
                if (data.sessions.length > 0) {
                    select.value = data.sessions[0].id;
                    selectedSessionId = data.sessions[0].id;
                    showSessionInfo(data.sessions[0]);
                }
            } catch (error) {
                console.error('Failed to load sessions:', error);
            }
        }

        document.getElementById('session-select').addEventListener('change', async (e) => {
            selectedSessionId = e.target.value;
            if (selectedSessionId) {
                const response = await fetch(`${API_BASE}/api/sessions/${selectedSessionId}`);
                const session = await response.json();
                showSessionInfo(session);
            }
        });

        function showSessionInfo(session) {
            const info = document.getElementById('session-info');
            info.style.display = 'block';
            info.innerHTML = `
                <div class="session-info-item">
                    <strong>Session ID:</strong>
                    <span>${session.id}</span>
                </div>
                <div class="session-info-item">
                    <strong>Status:</strong>
                    <span>${session.status}</span>
                </div>
                <div class="session-info-item">
                    <strong>Started:</strong>
                    <span>${new Date(session.started_at).toLocaleString()}</span>
                </div>
                <div class="session-info-item">
                    <strong>Features:</strong>
                    <span>${session.completed_features || 0} / ${session.total_features || 0}</span>
                </div>
            `;
        }

        function updateStepStatus(stepNum, status, result = null) {
            const step = document.getElementById(`step-${stepNum}`);
            const statusBadge = step.querySelector('.step-status');
            const resultDiv = document.getElementById(`result-${stepNum}`);

            step.className = `test-step ${status}`;
            statusBadge.className = `step-status ${status}`;
            statusBadge.textContent = status.charAt(0).toUpperCase() + status.slice(1);

            if (result) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = result;
            }

            if (status === 'passed') {
                testsPassed++;
                updateSummary();
            } else if (status === 'failed') {
                testsFailed++;
                updateSummary();
            }
        }

        function updateSummary() {
            document.getElementById('passed-tests').textContent = testsPassed;
            document.getElementById('failed-tests').textContent = testsFailed;
            const progress = ((testsPassed + testsFailed) / 6) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }

        async function runTests() {
            if (!selectedSessionId) {
                alert('Please select a session first');
                return;
            }

            testsPassed = 0;
            testsFailed = 0;
            updateSummary();

            // Step 1: Load sessions (already done)
            updateStepStatus(1, 'running');
            await new Promise(resolve => setTimeout(resolve, 500));
            updateStepStatus(1, 'passed', `<span class="success">âœ“ Loaded sessions successfully</span>`);

            // Step 2: Skip adding commits (not implemented in API yet)
            updateStepStatus(2, 'running');
            await new Promise(resolve => setTimeout(resolve, 500));
            updateStepStatus(2, 'passed', `<span class="success">âœ“ No commits to add (testing with existing data)</span>`);

            // Step 3: Get session commits
            updateStepStatus(3, 'running');
            try {
                const response = await fetch(`${API_BASE}/api/sessions/${selectedSessionId}/commits`);
                if (response.ok) {
                    const data = await response.json();
                    updateStepStatus(3, 'passed', `<span class="success">âœ“ GET request successful (200 OK)
Response: ${JSON.stringify(data, null, 2)}</span>`);

                    // Step 4: Verify format
                    updateStepStatus(4, 'running');
                    await new Promise(resolve => setTimeout(resolve, 500));

                    if (data.hasOwnProperty('session_id') &&
                        data.hasOwnProperty('commits') &&
                        Array.isArray(data.commits) &&
                        data.hasOwnProperty('total') &&
                        data.hasOwnProperty('timestamp')) {
                        updateStepStatus(4, 'passed', `<span class="success">âœ“ Response format is correct
- session_id: ${data.session_id}
- commits: array with ${data.commits.length} items
- total: ${data.total}
- timestamp: ${data.timestamp}</span>`);

                        // Step 5: Verify commit details
                        updateStepStatus(5, 'running');
                        await new Promise(resolve => setTimeout(resolve, 500));

                        if (data.commits.length > 0) {
                            const commit = data.commits[0];
                            const hasRequiredFields = commit.hasOwnProperty('commit_hash') &&
                                                     commit.hasOwnProperty('message') &&
                                                     commit.hasOwnProperty('timestamp');

                            if (hasRequiredFields) {
                                let commitHtml = '<span class="success">âœ“ Commits have required fields:</span>\n\n';
                                data.commits.forEach((c, i) => {
                                    commitHtml += `<div class="commit-entry">
                                        <div class="commit-hash">${c.commit_hash}</div>
                                        <div class="commit-message">${c.message}</div>
                                        <div class="commit-meta">Author: ${c.author || 'N/A'} | ${new Date(c.timestamp).toLocaleString()}</div>
                                    </div>`;
                                });
                                updateStepStatus(5, 'passed', commitHtml);
                            } else {
                                updateStepStatus(5, 'failed', `<span class="error">âœ— Commits missing required fields
First commit: ${JSON.stringify(commit, null, 2)}</span>`);
                            }
                        } else {
                            updateStepStatus(5, 'passed', `<span class="success">âœ“ No commits to verify (empty array is valid)</span>`);
                        }
                    } else {
                        updateStepStatus(4, 'failed', `<span class="error">âœ— Response format is incorrect
Expected: session_id, commits, total, timestamp
Got: ${JSON.stringify(Object.keys(data))}</span>`);
                        updateStepStatus(5, 'failed', '<span class="error">âœ— Skipped due to previous failure</span>');
                    }
                } else {
                    updateStepStatus(3, 'failed', `<span class="error">âœ— Request failed: ${response.status} ${response.statusText}</span>`);
                    updateStepStatus(4, 'failed', '<span class="error">âœ— Skipped due to previous failure</span>');
                    updateStepStatus(5, 'failed', '<span class="error">âœ— Skipped due to previous failure</span>');
                }
            } catch (error) {
                updateStepStatus(3, 'failed', `<span class="error">âœ— Request error: ${error.message}</span>`);
                updateStepStatus(4, 'failed', '<span class="error">âœ— Skipped due to previous failure</span>');
                updateStepStatus(5, 'failed', '<span class="error">âœ— Skipped due to previous failure</span>');
            }

            // Step 6: Test 404
            updateStepStatus(6, 'running');
            await new Promise(resolve => setTimeout(resolve, 500));
            try {
                const response = await fetch(`${API_BASE}/api/sessions/nonexistent-session-99999/commits`);
                if (response.status === 404) {
                    const error = await response.json();
                    updateStepStatus(6, 'passed', `<span class="success">âœ“ 404 error handling works correctly
Error: ${error.detail || 'Session not found'}</span>`);
                } else {
                    updateStepStatus(6, 'failed', `<span class="error">âœ— Expected 404, got ${response.status}</span>`);
                }
            } catch (error) {
                updateStepStatus(6, 'failed', `<span class="error">âœ— Request error: ${error.message}</span>`);
            }
        }
    </script>
</body>
</html>
