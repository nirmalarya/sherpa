<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Validation Test - SHERPA API</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .test-step {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-step h2 {
            color: #2980b9;
            margin-top: 0;
        }
        .test-step.pass {
            border-left: 5px solid #27ae60;
        }
        .test-step.fail {
            border-left: 5px solid #e74c3c;
        }
        .test-step.pending {
            border-left: 5px solid #95a5a6;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .result {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .result pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .pass-indicator {
            color: #27ae60;
            font-weight: bold;
        }
        .fail-indicator {
            color: #e74c3c;
            font-weight: bold;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 12px;
        }
        .status.pass {
            background: #27ae60;
            color: white;
        }
        .status.fail {
            background: #e74c3c;
            color: white;
        }
        .status.pending {
            background: #95a5a6;
            color: white;
        }
        .summary {
            background: #34495e;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .summary h2 {
            margin-top: 0;
            color: white;
        }
    </style>
</head>
<body>
    <h1>üß™ Request Validation Test Suite - SHERPA API</h1>
    <p>Testing comprehensive request validation for all API endpoints with Pydantic models</p>

    <div class="summary" id="summary">
        <h2>Test Summary</h2>
        <p>Status: <span id="overall-status">Not Started</span></p>
        <p>Passed: <span id="passed-count">0</span> / 7</p>
        <p>Failed: <span id="failed-count">0</span> / 7</p>
    </div>

    <button onclick="runAllTests()" style="background: #27ae60; font-size: 16px; padding: 12px 24px;">
        ‚ñ∂ Run All Tests
    </button>

    <!-- Test Step 1: Send malformed request -->
    <div class="test-step pending" id="step1">
        <h2>Step 1: Send Malformed Request</h2>
        <p><strong>Test:</strong> Send POST request with invalid data types to /api/sessions</p>
        <p><strong>Expected:</strong> 400 Bad Request status code</p>
        <button onclick="runStep1()">Run Step 1</button>
        <div id="result1" class="result" style="display:none;"></div>
    </div>

    <!-- Test Step 2: Verify 400 status returned -->
    <div class="test-step pending" id="step2">
        <h2>Step 2: Verify 400 Status Returned</h2>
        <p><strong>Test:</strong> Verify response status is exactly 400</p>
        <p><strong>Expected:</strong> Status code = 400</p>
        <button onclick="runStep2()">Run Step 2</button>
        <div id="result2" class="result" style="display:none;"></div>
    </div>

    <!-- Test Step 3: Verify validation errors listed -->
    <div class="test-step pending" id="step3">
        <h2>Step 3: Verify Validation Errors Listed</h2>
        <p><strong>Test:</strong> Check that error response contains detailed validation errors</p>
        <p><strong>Expected:</strong> Response has "details" array with field, message, and type</p>
        <button onclick="runStep3()">Run Step 3</button>
        <div id="result3" class="result" style="display:none;"></div>
    </div>

    <!-- Test Step 4: Send request with extra fields -->
    <div class="test-step pending" id="step4">
        <h2>Step 4: Send Request with Extra Fields</h2>
        <p><strong>Test:</strong> Send request with extra fields not in schema</p>
        <p><strong>Expected:</strong> Extra fields rejected (400 status) due to extra="forbid"</p>
        <button onclick="runStep4()">Run Step 4</button>
        <div id="result4" class="result" style="display:none;"></div>
    </div>

    <!-- Test Step 5: Verify extra fields ignored or rejected -->
    <div class="test-step pending" id="step5">
        <h2>Step 5: Verify Extra Fields Rejected</h2>
        <p><strong>Test:</strong> Confirm extra fields cause validation error</p>
        <p><strong>Expected:</strong> Error message indicates "extra fields not permitted"</p>
        <button onclick="runStep5()">Run Step 5</button>
        <div id="result5" class="result" style="display:none;"></div>
    </div>

    <!-- Test Step 6: Send valid request -->
    <div class="test-step pending" id="step6">
        <h2>Step 6: Send Valid Request</h2>
        <p><strong>Test:</strong> Send properly formatted request with all required fields</p>
        <p><strong>Expected:</strong> 201 Created status code</p>
        <button onclick="runStep6()">Run Step 6</button>
        <div id="result6" class="result" style="display:none;"></div>
    </div>

    <!-- Test Step 7: Verify accepted -->
    <div class="test-step pending" id="step7">
        <h2>Step 7: Verify Valid Request Accepted</h2>
        <p><strong>Test:</strong> Verify response contains session data and no errors</p>
        <p><strong>Expected:</strong> Response has "id" and "status" = "created"</p>
        <button onclick="runStep7()">Run Step 7</button>
        <div id="result7" class="result" style="display:none;"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';
        let testResults = {
            step1: null,
            step2: null,
            step3: null,
            step4: null,
            step5: null,
            step6: null,
            step7: null
        };

        function updateSummary() {
            const results = Object.values(testResults);
            const passed = results.filter(r => r === true).length;
            const failed = results.filter(r => r === false).length;

            document.getElementById('passed-count').textContent = passed;
            document.getElementById('failed-count').textContent = failed;

            if (passed === 7) {
                document.getElementById('overall-status').innerHTML = '<span class="pass-indicator">‚úÖ ALL TESTS PASSED</span>';
            } else if (failed > 0) {
                document.getElementById('overall-status').innerHTML = '<span class="fail-indicator">‚ùå SOME TESTS FAILED</span>';
            } else {
                document.getElementById('overall-status').textContent = 'In Progress...';
            }
        }

        function markStep(stepNum, passed, message) {
            const step = document.getElementById(`step${stepNum}`);
            const result = document.getElementById(`result${stepNum}`);

            step.className = `test-step ${passed ? 'pass' : 'fail'}`;
            result.style.display = 'block';
            result.innerHTML = `<pre>${message}</pre>`;

            testResults[`step${stepNum}`] = passed;
            updateSummary();
        }

        async function runStep1() {
            const output = [];
            output.push('üì§ Step 1: Sending malformed request to /api/sessions');
            output.push('Request body: { "total_features": "not_a_number", "spec_file": 123 }');

            try {
                const response = await fetch(`${API_BASE}/api/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        total_features: "not_a_number",  // Should be int
                        spec_file: 123  // Should be string
                    })
                });

                output.push(`\nüì® Response Status: ${response.status}`);
                const data = await response.json();
                output.push(`üì¶ Response Body:\n${JSON.stringify(data, null, 2)}`);

                const passed = response.status === 400;
                output.push(`\n${passed ? '‚úÖ' : '‚ùå'} Test ${passed ? 'PASSED' : 'FAILED'}: Status is ${response.status} (expected 400)`);

                markStep(1, passed, output.join('\n'));
            } catch (error) {
                output.push(`\n‚ùå Error: ${error.message}`);
                markStep(1, false, output.join('\n'));
            }
        }

        async function runStep2() {
            const output = [];
            output.push('üì§ Step 2: Verifying 400 status on malformed request');

            try {
                const response = await fetch(`${API_BASE}/api/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ total_features: -1 })  // Invalid: negative number
                });

                output.push(`üì® Response Status: ${response.status}`);
                const passed = response.status === 400;
                output.push(`\n${passed ? '‚úÖ' : '‚ùå'} Test ${passed ? 'PASSED' : 'FAILED'}: Status code is exactly 400`);

                markStep(2, passed, output.join('\n'));
            } catch (error) {
                output.push(`\n‚ùå Error: ${error.message}`);
                markStep(2, false, output.join('\n'));
            }
        }

        async function runStep3() {
            const output = [];
            output.push('üì§ Step 3: Checking validation error details');

            try {
                const response = await fetch(`${API_BASE}/api/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        total_features: "invalid",
                        spec_file: ""  // Empty string (min_length=1)
                    })
                });

                const data = await response.json();
                output.push(`üì¶ Response Body:\n${JSON.stringify(data, null, 2)}`);

                const hasError = data.error !== undefined;
                const hasMessage = data.message !== undefined;
                const hasDetails = Array.isArray(data.details) && data.details.length > 0;
                const detailsHaveFields = hasDetails && data.details.every(d =>
                    d.field !== undefined && d.message !== undefined && d.type !== undefined
                );

                output.push(`\n‚úì Has "error" field: ${hasError}`);
                output.push(`‚úì Has "message" field: ${hasMessage}`);
                output.push(`‚úì Has "details" array: ${hasDetails}`);
                output.push(`‚úì Details have field/message/type: ${detailsHaveFields}`);

                const passed = hasError && hasMessage && hasDetails && detailsHaveFields;
                output.push(`\n${passed ? '‚úÖ' : '‚ùå'} Test ${passed ? 'PASSED' : 'FAILED'}: Validation errors properly listed`);

                markStep(3, passed, output.join('\n'));
            } catch (error) {
                output.push(`\n‚ùå Error: ${error.message}`);
                markStep(3, false, output.join('\n'));
            }
        }

        async function runStep4() {
            const output = [];
            output.push('üì§ Step 4: Sending request with extra fields');
            output.push('Request body includes: { "total_features": 5, "extra_field": "should_reject" }');

            try {
                const response = await fetch(`${API_BASE}/api/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        total_features: 5,
                        extra_field: "should_reject",  // Extra field not in schema
                        another_extra: true
                    })
                });

                output.push(`\nüì® Response Status: ${response.status}`);
                const data = await response.json();
                output.push(`üì¶ Response Body:\n${JSON.stringify(data, null, 2)}`);

                const passed = response.status === 400;
                output.push(`\n${passed ? '‚úÖ' : '‚ùå'} Test ${passed ? 'PASSED' : 'FAILED'}: Extra fields rejected with 400 status`);

                markStep(4, passed, output.join('\n'));
            } catch (error) {
                output.push(`\n‚ùå Error: ${error.message}`);
                markStep(4, false, output.join('\n'));
            }
        }

        async function runStep5() {
            const output = [];
            output.push('üì§ Step 5: Verifying extra fields error message');

            try {
                const response = await fetch(`${API_BASE}/api/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        total_features: 10,
                        forbidden_field: "test"
                    })
                });

                const data = await response.json();
                output.push(`üì¶ Response Body:\n${JSON.stringify(data, null, 2)}`);

                const errorMessage = JSON.stringify(data).toLowerCase();
                const mentionsExtra = errorMessage.includes('extra') ||
                                     errorMessage.includes('forbidden') ||
                                     errorMessage.includes('not permitted') ||
                                     errorMessage.includes('additional');

                output.push(`\n‚úì Error mentions extra/forbidden fields: ${mentionsExtra}`);

                const passed = response.status === 400 && mentionsExtra;
                output.push(`\n${passed ? '‚úÖ' : '‚ùå'} Test ${passed ? 'PASSED' : 'FAILED'}: Extra fields error clearly indicated`);

                markStep(5, passed, output.join('\n'));
            } catch (error) {
                output.push(`\n‚ùå Error: ${error.message}`);
                markStep(5, false, output.join('\n'));
            }
        }

        async function runStep6() {
            const output = [];
            output.push('üì§ Step 6: Sending valid request');
            output.push('Request body: { "spec_file": "test.txt", "total_features": 10 }');

            try {
                const response = await fetch(`${API_BASE}/api/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        spec_file: "validation_test.txt",
                        total_features: 10,
                        work_item_id: "WI-123",
                        git_branch: "feature/validation-test"
                    })
                });

                output.push(`\nüì® Response Status: ${response.status}`);
                const data = await response.json();
                output.push(`üì¶ Response Body:\n${JSON.stringify(data, null, 2)}`);

                const passed = response.status === 201;
                output.push(`\n${passed ? '‚úÖ' : '‚ùå'} Test ${passed ? 'PASSED' : 'FAILED'}: Valid request accepted with 201 status`);

                markStep(6, passed, output.join('\n'));
            } catch (error) {
                output.push(`\n‚ùå Error: ${error.message}`);
                markStep(6, false, output.join('\n'));
            }
        }

        async function runStep7() {
            const output = [];
            output.push('üì§ Step 7: Verifying valid request creates session');

            try {
                const response = await fetch(`${API_BASE}/api/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        spec_file: "final_validation_test.txt",
                        total_features: 25
                    })
                });

                const data = await response.json();
                output.push(`üì¶ Response Body:\n${JSON.stringify(data, null, 2)}`);

                const hasId = data.id !== undefined;
                const hasStatus = data.status === "created";
                const hasTimestamp = data.timestamp !== undefined;
                const noErrors = data.error === undefined;

                output.push(`\n‚úì Has "id" field: ${hasId}`);
                output.push(`‚úì Has "status" = "created": ${hasStatus}`);
                output.push(`‚úì Has "timestamp": ${hasTimestamp}`);
                output.push(`‚úì No errors in response: ${noErrors}`);

                const passed = response.status === 201 && hasId && hasStatus && hasTimestamp && noErrors;
                output.push(`\n${passed ? '‚úÖ' : '‚ùå'} Test ${passed ? 'PASSED' : 'FAILED'}: Valid request properly processed`);

                markStep(7, passed, output.join('\n'));
            } catch (error) {
                output.push(`\n‚ùå Error: ${error.message}`);
                markStep(7, false, output.join('\n'));
            }
        }

        async function runAllTests() {
            document.getElementById('overall-status').textContent = 'Running tests...';

            await runStep1();
            await new Promise(resolve => setTimeout(resolve, 500));

            await runStep2();
            await new Promise(resolve => setTimeout(resolve, 500));

            await runStep3();
            await new Promise(resolve => setTimeout(resolve, 500));

            await runStep4();
            await new Promise(resolve => setTimeout(resolve, 500));

            await runStep5();
            await new Promise(resolve => setTimeout(resolve, 500));

            await runStep6();
            await new Promise(resolve => setTimeout(resolve, 500));

            await runStep7();

            // Final summary
            const passed = Object.values(testResults).filter(r => r === true).length;
            console.log(`\nüéØ FINAL RESULTS: ${passed}/7 tests passed`);
        }
    </script>
</body>
</html>
