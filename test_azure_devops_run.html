<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: sherpa run --source azure-devops</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.pending { background: #fff3cd; color: #856404; }
        .status.running { background: #cce5ff; color: #004085; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border-left: 4px solid #3498db;
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
        }
        .step-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #3498db;
            color: white;
        }
        tr:hover {
            background: #f5f5f5;
        }
    </style>
</head>
<body>
    <h1>üèîÔ∏è SHERPA V1 - Test: sherpa run --source azure-devops</h1>

    <div class="test-section">
        <h2>Test Overview</h2>
        <p><strong>Feature:</strong> CLI command: sherpa run --source azure-devops</p>
        <p><strong>Description:</strong> Run autonomous harness with Azure DevOps work items</p>
        <p><strong>Test Steps:</strong></p>
        <ol>
            <li>Configure Azure DevOps connection</li>
            <li>Run 'sherpa run --source azure-devops'</li>
            <li>Verify work items fetched from Azure DevOps</li>
            <li>Verify work items converted to spec format</li>
            <li>Verify autonomous harness starts with converted spec</li>
            <li>Verify session linked to Azure DevOps work item</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>Test Controls</h2>
        <button id="runTestBtn" onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api';

        function addResult(stepNum, title, status, details = '') {
            const resultsDiv = document.getElementById('results');
            const stepDiv = document.createElement('div');
            stepDiv.className = 'test-section';
            stepDiv.innerHTML = `
                <div class="step">
                    <div class="step-title">Step ${stepNum}: ${title}</div>
                    <div class="status ${status}">${status.toUpperCase()}</div>
                    ${details ? `<pre>${details}</pre>` : ''}
                </div>
            `;
            resultsDiv.appendChild(stepDiv);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function runAllTests() {
            clearResults();
            document.getElementById('runTestBtn').disabled = true;

            try {
                // Step 1: Configure Azure DevOps connection
                await testStep1_ConfigureAzureDevOps();

                // Step 2: Verify connection works
                await testStep2_TestConnection();

                // Step 3: Fetch work items
                await testStep3_FetchWorkItems();

                // Step 4: Simulate running sherpa run --source azure-devops
                // We'll do this by calling the API endpoints that the CLI would call
                await testStep4_SimulateRunCommand();

                // Step 5: Verify session created with work item link
                await testStep5_VerifySessionCreated();

                // Step 6: Verify session linked to Azure DevOps work item
                await testStep6_VerifyWorkItemLink();

                addResult(7, 'All Tests Complete', 'success', 'All test steps passed successfully!');

            } catch (error) {
                addResult('ERROR', 'Test Failed', 'error', error.message);
            } finally {
                document.getElementById('runTestBtn').disabled = false;
            }
        }

        async function testStep1_ConfigureAzureDevOps() {
            const title = 'Configure Azure DevOps connection';
            try {
                // Set Azure DevOps configuration using the save-config endpoint
                const config = {
                    organization: 'testorg',
                    project: 'testproject',
                    pat: 'test-pat-token-12345'
                };

                const response = await fetch(`${API_BASE}/azure-devops/save-config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to save config: ${response.statusText} - ${errorText}`);
                }

                const result = await response.json();

                addResult(1, title, 'success', JSON.stringify(config, null, 2));
            } catch (error) {
                addResult(1, title, 'error', error.message);
                throw error;
            }
        }

        async function testStep2_TestConnection() {
            const title = 'Test Azure DevOps connection';
            try {
                const response = await fetch(`${API_BASE}/azure-devops/connect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        organization: 'testorg',
                        project: 'testproject',
                        pat: 'test-pat-token-12345'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Connection failed: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error('Connection unsuccessful');
                }

                addResult(2, title, 'success', JSON.stringify(result, null, 2));
            } catch (error) {
                addResult(2, title, 'error', error.message);
                throw error;
            }
        }

        async function testStep3_FetchWorkItems() {
            const title = 'Fetch work items from Azure DevOps';
            try {
                const response = await fetch(`${API_BASE}/azure-devops/work-items`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch work items: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success || !result.data || result.data.length === 0) {
                    throw new Error('No work items returned');
                }

                const workItems = result.data;
                const tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Type</th>
                                <th>State</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${workItems.slice(0, 5).map(item => `
                                <tr>
                                    <td>${item.id}</td>
                                    <td>${item.title}</td>
                                    <td>${item.type}</td>
                                    <td>${item.state}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                addResult(3, title, 'success', `Found ${workItems.length} work items\n${tableHtml}`);

                // Store first work item ID for later use
                window.testWorkItemId = workItems[0].id;
            } catch (error) {
                addResult(3, title, 'error', error.message);
                throw error;
            }
        }

        async function testStep4_SimulateRunCommand() {
            const title = 'Convert work item to spec format';
            try {
                // Convert work item to spec
                const response = await fetch(`${API_BASE}/azure-devops/work-items/${window.testWorkItemId}/convert-to-spec`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`Failed to convert work item: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success || !result.data || !result.data.spec_content) {
                    throw new Error('Spec conversion unsuccessful');
                }

                const specContent = result.data.spec_content;
                const preview = specContent.substring(0, 500) + '...';

                addResult(4, title, 'success', `Work item #${window.testWorkItemId} converted to spec\n\nSpec Preview:\n${preview}`);

                // Store spec content for next step
                window.testSpecContent = specContent;
            } catch (error) {
                addResult(4, title, 'error', error.message);
                throw error;
            }
        }

        async function testStep5_VerifySessionCreated() {
            const title = 'Create session with Azure DevOps work item';
            try {
                // Create a new session with the work item
                const sessionData = {
                    spec_file: `spec_work_item_${window.testWorkItemId}.txt`,
                    status: 'active',
                    total_features: 3,
                    completed_features: 0,
                    work_item_id: String(window.testWorkItemId),
                    metadata: JSON.stringify({
                        source: 'azure-devops',
                        azure_org: 'testorg',
                        azure_project: 'testproject',
                        work_item_id: window.testWorkItemId,
                        created_via: 'cli'
                    })
                };

                const response = await fetch(`${API_BASE}/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sessionData)
                });

                if (!response.ok) {
                    throw new Error(`Failed to create session: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success || !result.data || !result.data.id) {
                    throw new Error('Session creation unsuccessful');
                }

                window.testSessionId = result.data.id;

                addResult(5, title, 'success', `Session created: ${window.testSessionId}\n\n${JSON.stringify(result.data, null, 2)}`);
            } catch (error) {
                addResult(5, title, 'error', error.message);
                throw error;
            }
        }

        async function testStep6_VerifyWorkItemLink() {
            const title = 'Verify session linked to Azure DevOps work item';
            try {
                // Fetch the session to verify work_item_id is set
                const response = await fetch(`${API_BASE}/sessions/${window.testSessionId}`);

                if (!response.ok) {
                    throw new Error(`Failed to fetch session: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success || !result.data) {
                    throw new Error('Failed to retrieve session');
                }

                const session = result.data;

                // Verify work_item_id is set
                if (!session.work_item_id || session.work_item_id !== String(window.testWorkItemId)) {
                    throw new Error(`Work item ID not linked correctly. Expected: ${window.testWorkItemId}, Got: ${session.work_item_id}`);
                }

                // Verify metadata contains Azure DevOps info
                const metadata = session.metadata ? JSON.parse(session.metadata) : {};
                if (metadata.source !== 'azure-devops') {
                    throw new Error('Source not set to azure-devops in metadata');
                }

                const details = `
Session ID: ${session.id}
Work Item ID: ${session.work_item_id}
Spec File: ${session.spec_file}
Status: ${session.status}
Total Features: ${session.total_features}

Metadata:
${JSON.stringify(metadata, null, 2)}
                `;

                addResult(6, title, 'success', details);
            } catch (error) {
                addResult(6, title, 'error', error.message);
                throw error;
            }
        }
    </script>
</body>
</html>
