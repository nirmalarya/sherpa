<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE Progress Endpoint Test - SHERPA V1</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 30px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .test-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 4px;
            border-left: 4px solid #ccc;
        }
        .test-section.running {
            border-left-color: #ffc107;
        }
        .test-section.success {
            border-left-color: #28a745;
        }
        .test-section.error {
            border-left-color: #dc3545;
        }
        .step-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }
        .step-list li {
            padding: 8px 0;
            color: #666;
        }
        .step-list li.completed {
            color: #28a745;
            font-weight: 500;
        }
        .step-list li.error {
            color: #dc3545;
            font-weight: 500;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status.pending { background: #f0f0f0; color: #666; }
        .status.running { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        button.stop {
            background: #dc3545;
        }
        button.stop:hover {
            background: #c82333;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .event-log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
        }
        .event {
            margin-bottom: 10px;
            padding: 8px;
            background: #2d2d2d;
            border-radius: 3px;
        }
        .event.connected { border-left: 3px solid #007bff; }
        .event.progress { border-left: 3px solid #28a745; }
        .event.complete { border-left: 3px solid #17a2b8; }
        .event.error { border-left: 3px solid #dc3545; }
        .event-type {
            color: #4ec9b0;
            font-weight: bold;
        }
        .event-time {
            color: #9cdcfe;
            font-size: 11px;
        }
        .event-data {
            color: #ce9178;
            margin-top: 5px;
        }
        .summary {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 30px;
            border-left: 4px solid #007bff;
        }
        .summary h2 {
            margin: 0 0 15px 0;
            color: #0056b3;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .stat {
            background: white;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-transform: uppercase;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .session-selector {
            margin-bottom: 15px;
        }
        .session-selector label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        .session-selector select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèîÔ∏è SHERPA V1 - SSE Progress Endpoint Test</h1>
        <p class="subtitle">Testing GET /api/sessions/:id/progress - Server-Sent Events for real-time progress updates</p>

        <div class="summary">
            <h2>Test Summary</h2>
            <div class="summary-stats">
                <div class="stat">
                    <div class="stat-value" id="eventCount">0</div>
                    <div class="stat-label">Events Received</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="progressCount">0</div>
                    <div class="stat-label">Progress Updates</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="connectionStatus">Disconnected</div>
                    <div class="stat-label">Connection Status</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="session-selector">
                <label for="sessionSelect">Select Session:</label>
                <select id="sessionSelect">
                    <option value="">Loading sessions...</option>
                </select>
            </div>
            <button id="startBtn" onclick="startTest()">‚ñ∂Ô∏è Start SSE Connection</button>
            <button id="stopBtn" class="stop" onclick="stopConnection()" disabled>‚èπÔ∏è Stop Connection</button>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <!-- Step 1: Load Sessions -->
        <div class="test-section" id="step1">
            <h3>Step 1: Load Available Sessions</h3>
            <span class="status pending" id="step1-status">PENDING</span>
            <ul class="step-list">
                <li id="step1-1">1. GET /api/sessions to retrieve all sessions</li>
                <li id="step1-2">2. Verify sessions array returned</li>
                <li id="step1-3">3. Populate session selector</li>
            </ul>
            <div class="result" id="step1-result" style="display:none"></div>
        </div>

        <!-- Step 2: Connect SSE -->
        <div class="test-section" id="step2">
            <h3>Step 2: Establish SSE Connection</h3>
            <span class="status pending" id="step2-status">PENDING</span>
            <ul class="step-list">
                <li id="step2-1">1. Create EventSource connection to /api/sessions/:id/progress</li>
                <li id="step2-2">2. Verify connection established</li>
                <li id="step2-3">3. Set up event listeners</li>
            </ul>
            <div class="result" id="step2-result" style="display:none"></div>
        </div>

        <!-- Step 3: Receive Connected Event -->
        <div class="test-section" id="step3">
            <h3>Step 3: Receive "connected" Event</h3>
            <span class="status pending" id="step3-status">PENDING</span>
            <ul class="step-list">
                <li id="step3-1">1. Wait for initial "connected" event</li>
                <li id="step3-2">2. Verify event data contains session_id</li>
                <li id="step3-3">3. Verify event data contains timestamp</li>
            </ul>
            <div class="result" id="step3-result" style="display:none"></div>
        </div>

        <!-- Step 4: Receive Progress Events -->
        <div class="test-section" id="step4">
            <h3>Step 4: Receive "progress" Events</h3>
            <span class="status pending" id="step4-status">PENDING</span>
            <ul class="step-list">
                <li id="step4-1">1. Receive progress event updates</li>
                <li id="step4-2">2. Verify events contain required fields (session_id, status, total_features, completed_features)</li>
                <li id="step4-3">3. Verify progress_percent is calculated correctly</li>
                <li id="step4-4">4. Verify events arrive at regular intervals</li>
            </ul>
            <div class="result" id="step4-result" style="display:none"></div>
        </div>

        <!-- Step 5: Receive Complete Event -->
        <div class="test-section" id="step5">
            <h3>Step 5: Receive "complete" Event</h3>
            <span class="status pending" id="step5-status">PENDING</span>
            <ul class="step-list">
                <li id="step5-1">1. Wait for final "complete" event</li>
                <li id="step5-2">2. Verify event data contains session_id</li>
                <li id="step5-3">3. Verify connection closes gracefully</li>
            </ul>
            <div class="result" id="step5-result" style="display:none"></div>
        </div>

        <!-- Step 6: Test Error Handling -->
        <div class="test-section" id="step6">
            <h3>Step 6: Test Error Handling (Non-existent Session)</h3>
            <span class="status pending" id="step6-status">PENDING</span>
            <ul class="step-list">
                <li id="step6-1">1. Connect to non-existent session</li>
                <li id="step6-2">2. Verify "error" event received</li>
                <li id="step6-3">3. Verify error message: "Session not found"</li>
            </ul>
            <div class="result" id="step6-result" style="display:none"></div>
            <button onclick="testErrorHandling()" style="margin-top: 10px;">Test Error Handling</button>
        </div>

        <!-- Event Log -->
        <div style="margin-top: 30px;">
            <h3>üì° Live Event Stream</h3>
            <div class="event-log" id="eventLog">
                <div style="color: #888; text-align: center; padding: 20px;">
                    No events yet. Click "Start SSE Connection" to begin.
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';
        let eventSource = null;
        let sessions = [];
        let eventCount = 0;
        let progressCount = 0;
        let progressEvents = [];

        // Auto-load sessions on page load
        window.addEventListener('load', () => {
            loadSessions();
        });

        async function loadSessions() {
            const step1 = document.getElementById('step1');
            const status = document.getElementById('step1-status');
            const result = document.getElementById('step1-result');

            step1.className = 'test-section running';
            status.className = 'status running';
            status.textContent = 'RUNNING';

            try {
                // Step 1-1
                document.getElementById('step1-1').className = 'completed';
                const response = await fetch(`${API_BASE}/api/sessions`);

                // Step 1-2
                const data = await response.json();
                sessions = data.sessions || [];
                document.getElementById('step1-2').className = 'completed';

                // Step 1-3
                const select = document.getElementById('sessionSelect');
                select.innerHTML = '';

                if (sessions.length === 0) {
                    select.innerHTML = '<option value="">No sessions available</option>';
                } else {
                    sessions.forEach(session => {
                        const option = document.createElement('option');
                        option.value = session.id;
                        option.textContent = `${session.id} (${session.status}) - ${session.spec_file || 'No spec'}`;
                        select.appendChild(option);
                    });
                }
                document.getElementById('step1-3').className = 'completed';

                result.style.display = 'block';
                result.textContent = `‚úÖ Loaded ${sessions.length} sessions\n\n${JSON.stringify(data, null, 2)}`;

                step1.className = 'test-section success';
                status.className = 'status success';
                status.textContent = 'SUCCESS';
            } catch (error) {
                result.style.display = 'block';
                result.textContent = `‚ùå Error: ${error.message}`;
                step1.className = 'test-section error';
                status.className = 'status error';
                status.textContent = 'ERROR';
            }
        }

        function startTest() {
            const sessionId = document.getElementById('sessionSelect').value;
            if (!sessionId) {
                alert('Please select a session first');
                return;
            }

            // Reset counters
            eventCount = 0;
            progressCount = 0;
            progressEvents = [];
            updateStats();

            // Connect SSE
            connectSSE(sessionId);
        }

        function connectSSE(sessionId) {
            const step2 = document.getElementById('step2');
            const status = document.getElementById('step2-status');
            const result = document.getElementById('step2-result');

            step2.className = 'test-section running';
            status.className = 'status running';
            status.textContent = 'RUNNING';

            try {
                // Step 2-1: Create EventSource
                const url = `${API_BASE}/api/sessions/${sessionId}/progress`;
                eventSource = new EventSource(url);
                document.getElementById('step2-1').className = 'completed';

                // Step 2-2: Connection established
                eventSource.onopen = () => {
                    document.getElementById('step2-2').className = 'completed';
                    addEventToLog('Connection', 'EventSource connection opened', {});
                    updateConnectionStatus('Connected');
                };

                // Step 2-3: Set up event listeners
                setupEventListeners(sessionId);
                document.getElementById('step2-3').className = 'completed';

                result.style.display = 'block';
                result.textContent = `‚úÖ SSE connection established to:\n${url}`;

                step2.className = 'test-section success';
                status.className = 'status success';
                status.textContent = 'SUCCESS';

                // Enable stop button
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
            } catch (error) {
                result.style.display = 'block';
                result.textContent = `‚ùå Error: ${error.message}`;
                step2.className = 'test-section error';
                status.className = 'status error';
                status.textContent = 'ERROR';
            }
        }

        function setupEventListeners(sessionId) {
            // Listen for "connected" event
            eventSource.addEventListener('connected', (e) => {
                const data = JSON.parse(e.data);
                handleConnectedEvent(data);
            });

            // Listen for "progress" event
            eventSource.addEventListener('progress', (e) => {
                const data = JSON.parse(e.data);
                handleProgressEvent(data);
            });

            // Listen for "complete" event
            eventSource.addEventListener('complete', (e) => {
                const data = JSON.parse(e.data);
                handleCompleteEvent(data);
            });

            // Listen for "error" event from server
            eventSource.addEventListener('error', (e) => {
                if (e.data) {
                    const data = JSON.parse(e.data);
                    handleErrorEvent(data);
                }
            });

            // Handle connection errors
            eventSource.onerror = (e) => {
                console.error('SSE Error:', e);
                if (eventSource.readyState === EventSource.CLOSED) {
                    addEventToLog('Error', 'Connection closed', { readyState: eventSource.readyState });
                    updateConnectionStatus('Disconnected');
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                }
            };
        }

        function handleConnectedEvent(data) {
            eventCount++;
            updateStats();
            addEventToLog('connected', 'Initial connection established', data);

            const step3 = document.getElementById('step3');
            const status = document.getElementById('step3-status');
            const result = document.getElementById('step3-result');

            step3.className = 'test-section running';
            status.className = 'status running';
            status.textContent = 'RUNNING';

            // Step 3-1
            document.getElementById('step3-1').className = 'completed';

            // Step 3-2: Verify session_id
            if (data.session_id) {
                document.getElementById('step3-2').className = 'completed';
            } else {
                document.getElementById('step3-2').className = 'error';
            }

            // Step 3-3: Verify timestamp
            if (data.timestamp) {
                document.getElementById('step3-3').className = 'completed';
            } else {
                document.getElementById('step3-3').className = 'error';
            }

            result.style.display = 'block';
            result.textContent = `‚úÖ Connected event received\n\n${JSON.stringify(data, null, 2)}`;

            step3.className = 'test-section success';
            status.className = 'status success';
            status.textContent = 'SUCCESS';
        }

        function handleProgressEvent(data) {
            eventCount++;
            progressCount++;
            progressEvents.push(data);
            updateStats();
            addEventToLog('progress', `Update ${data.update_number || progressCount}`, data);

            const step4 = document.getElementById('step4');
            const status = document.getElementById('step4-status');
            const result = document.getElementById('step4-result');

            step4.className = 'test-section running';
            status.className = 'status running';
            status.textContent = 'RUNNING';

            // Step 4-1
            document.getElementById('step4-1').className = 'completed';

            // Step 4-2: Verify required fields
            const requiredFields = ['session_id', 'status', 'total_features', 'completed_features'];
            const hasAllFields = requiredFields.every(field => field in data);
            if (hasAllFields) {
                document.getElementById('step4-2').className = 'completed';
            }

            // Step 4-3: Verify progress_percent
            if ('progress_percent' in data) {
                const expectedPercent = data.total_features > 0
                    ? (data.completed_features / data.total_features * 100)
                    : 0;
                if (Math.abs(data.progress_percent - expectedPercent) < 0.01) {
                    document.getElementById('step4-3').className = 'completed';
                }
            }

            // Step 4-4: Verify regular intervals (will complete after multiple events)
            if (progressCount >= 3) {
                document.getElementById('step4-4').className = 'completed';
            }

            result.style.display = 'block';
            result.textContent = `‚úÖ Received ${progressCount} progress events\n\nLatest event:\n${JSON.stringify(data, null, 2)}`;

            if (progressCount >= 3) {
                step4.className = 'test-section success';
                status.className = 'status success';
                status.textContent = 'SUCCESS';
            }
        }

        function handleCompleteEvent(data) {
            eventCount++;
            updateStats();
            addEventToLog('complete', 'Stream completed', data);

            const step5 = document.getElementById('step5');
            const status = document.getElementById('step5-status');
            const result = document.getElementById('step5-result');

            step5.className = 'test-section running';
            status.className = 'status running';
            status.textContent = 'RUNNING';

            // Step 5-1
            document.getElementById('step5-1').className = 'completed';

            // Step 5-2: Verify session_id
            if (data.session_id) {
                document.getElementById('step5-2').className = 'completed';
            }

            // Step 5-3: Connection closes gracefully
            setTimeout(() => {
                if (eventSource) {
                    eventSource.close();
                    document.getElementById('step5-3').className = 'completed';
                    updateConnectionStatus('Disconnected');
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                }
            }, 500);

            result.style.display = 'block';
            result.textContent = `‚úÖ Complete event received\n\n${JSON.stringify(data, null, 2)}`;

            step5.className = 'test-section success';
            status.className = 'status success';
            status.textContent = 'SUCCESS';
        }

        function handleErrorEvent(data) {
            eventCount++;
            updateStats();
            addEventToLog('error', 'Error event received', data);
        }

        function testErrorHandling() {
            const fakeSessionId = 'session-nonexistent-99999';

            const step6 = document.getElementById('step6');
            const status = document.getElementById('step6-status');
            const result = document.getElementById('step6-result');

            step6.className = 'test-section running';
            status.className = 'status running';
            status.textContent = 'RUNNING';

            // Step 6-1
            const url = `${API_BASE}/api/sessions/${fakeSessionId}/progress`;
            const errorEventSource = new EventSource(url);
            document.getElementById('step6-1').className = 'completed';

            errorEventSource.addEventListener('error', (e) => {
                try {
                    const data = JSON.parse(e.data);

                    // Step 6-2
                    document.getElementById('step6-2').className = 'completed';

                    // Step 6-3: Verify error message
                    if (data.error && data.error.includes('not found')) {
                        document.getElementById('step6-3').className = 'completed';
                    }

                    result.style.display = 'block';
                    result.textContent = `‚úÖ Error handling works correctly\n\n${JSON.stringify(data, null, 2)}`;

                    step6.className = 'test-section success';
                    status.className = 'status success';
                    status.textContent = 'SUCCESS';

                    errorEventSource.close();
                } catch (err) {
                    console.error('Error parsing error event:', err);
                }
            });

            // Also handle connection errors
            errorEventSource.onerror = () => {
                setTimeout(() => {
                    errorEventSource.close();
                }, 2000);
            };
        }

        function stopConnection() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                updateConnectionStatus('Disconnected');
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                addEventToLog('System', 'Connection stopped by user', {});
            }
        }

        function clearLog() {
            document.getElementById('eventLog').innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Event log cleared.</div>';
        }

        function updateStats() {
            document.getElementById('eventCount').textContent = eventCount;
            document.getElementById('progressCount').textContent = progressCount;
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = status;
            statusEl.style.color = status === 'Connected' ? '#28a745' : '#dc3545';
        }

        function addEventToLog(type, message, data) {
            const log = document.getElementById('eventLog');

            // Clear placeholder if exists
            if (log.innerHTML.includes('No events yet')) {
                log.innerHTML = '';
            }

            const eventDiv = document.createElement('div');
            eventDiv.className = `event ${type.toLowerCase()}`;

            const time = new Date().toLocaleTimeString();
            eventDiv.innerHTML = `
                <div class="event-time">[${time}]</div>
                <div class="event-type">${type.toUpperCase()}</div>
                <div>${message}</div>
                ${Object.keys(data).length > 0 ? `<div class="event-data">${JSON.stringify(data, null, 2)}</div>` : ''}
            `;

            log.appendChild(eventDiv);
            log.scrollTop = log.scrollHeight;
        }
    </script>
</body>
</html>
